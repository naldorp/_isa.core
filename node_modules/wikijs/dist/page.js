'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

exports.default = wikiPage;

var _underscore = require('underscore');

var _underscore2 = _interopRequireDefault(_underscore);

var _util = require('./util');

var _determiners = require('./determiners');

var _determiners2 = _interopRequireDefault(_determiners);

var _wikiInfoboxParserCore = require('wiki-infobox-parser-core');

var _wikiInfoboxParserCore2 = _interopRequireDefault(_wikiInfoboxParserCore);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function markupParser(data) {
	return new Promise(function (resolve, reject) {
		(0, _wikiInfoboxParserCore2.default)(data, function (err, resultString) {
			if (err) {
				reject(err);
			} else {
				resolve(JSON.parse(resultString));
			}
		});
	});
}

var keyValuePairPattern = /\w+=[\d\w]+/g;

function parseDeprecatedCoord(coord) {
	return coord.match(keyValuePairPattern).reduce(function (memo, pair) {
		var _pair$split = pair.split('=');

		var _pair$split2 = _slicedToArray(_pair$split, 2);

		var key = _pair$split2[0];
		var value = _pair$split2[1];

		var floatValue = parseFloat(value);
		return Object.assign({}, memo, _defineProperty({}, key, isNaN(floatValue) ? value : floatValue));
	}, {});
}

/**
 * WikiPage
 * @namespace WikiPage
 */
function wikiPage(rawPageInfo, apiOptions) {

	var raw = rawPageInfo;

	/**
  * HTML from page
  * @example
  * wiki.page('batman').then(page => page.html()).then(console.log);
  * @method WikiPage#html
  * @return {Promise}
  */
	function html() {
		return (0, _util.api)(apiOptions, {
			prop: 'revisions',
			rvprop: 'content',
			rvlimit: 1,
			rvparse: '',
			titles: raw.title
		}).then(function (res) {
			return res.query.pages[raw.pageid].revisions[0]['*'];
		});
	}

	/**
  * Text content from page
  * @example
  * wiki.page('batman').then(page => page.content()).then(console.log);
  * @method WikiPage#content
  * @return {Promise}
  */
	function content() {
		return (0, _util.api)(apiOptions, {
			prop: 'extracts',
			explaintext: '',
			titles: raw.title
		}).then(function (res) {
			return res.query.pages[raw.pageid].extract;
		});
	}

	/**
  * Text summary from page
  * @example
  * wiki.page('batman').then(page => page.summary()).then(console.log);
  * @method WikiPage#summary
  * @return {Promise}
  */
	function summary() {
		return (0, _util.api)(apiOptions, {
			prop: 'extracts',
			explaintext: '',
			exintro: '',
			titles: raw.title
		}).then(function (res) {
			return res.query.pages[raw.pageid].extract;
		});
	}

	/**
  * Raw data from images from page
  * @example
  * wiki.page('batman').then(page => page.rawImages()).then(console.log);
  * @method WikiPage#rawImages
  * @return {Promise}
  */
	function rawImages() {
		return (0, _util.api)(apiOptions, {
			generator: 'images',
			gimlimit: 'max',
			prop: 'imageinfo',
			iiprop: 'url',
			titles: raw.title
		}).then(function (res) {
			if (res.query) {
				return _underscore2.default.values(res.query.pages);
			}
			return [];
		});
	}

	/**
  * Main image URL from infobox on page
  * @example
  * wiki.page('batman').then(page => page.mainImage()).then(console.log);
  * @method WikiPage#mainImage
  * @return {Promise}
  */
	function mainImage() {
		return Promise.all([rawImages(), info()]).then(function (_ref) {
			var _ref2 = _slicedToArray(_ref, 2);

			var images = _ref2[0];
			var info = _ref2[1];

			var image = images.find(function (image) {
				return image.title === 'File:' + info.image;
			});
			return image.imageinfo.length > 0 ? image.imageinfo[0].url : undefined;
		});
	}

	/**
  * Image URL's from page
  * @example
  * wiki.page('batman').then(page => page.image()).then(console.log);
  * @method WikiPage#images
  * @return {Promise}
  */
	function images() {
		return rawImages().then(function (images) {
			return _underscore2.default.chain(images).pluck('imageinfo').flatten().pluck('url').value();
		});
	}

	/**
  * References from page
  * @example
  * wiki.page('batman').then(page => page.references()).then(console.log);
  * @method WikiPage#references
  * @return {Promise}
  */
	function references() {
		return (0, _util.api)(apiOptions, {
			prop: 'extlinks',
			ellimit: 'max',
			titles: raw.title
		}).then(function (res) {
			return _underscore2.default.pluck(res.query.pages[raw.pageid].extlinks, '*');
		});
	}

	/**
  * Paginated links from page
  * @example
  * wiki.page('batman').then(page => page.links()).then(console.log);
  * @method WikiPage#links
  * @param  {Boolean} [aggregated] - return all links (default is true)
  * @param  {Number} [limit] - number of links per page
  * @return {Promise} - returns results if aggregated [and next function for more results if not aggregated]
  */
	function links() {
		var aggregated = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
		var limit = arguments.length <= 1 || arguments[1] === undefined ? 100 : arguments[1];

		var _pagination = (0, _util.pagination)(apiOptions, {
			prop: 'links',
			plnamespace: 0,
			pllimit: limit,
			titles: raw.title
		}, function (res) {
			return _underscore2.default.pluck(res.query.pages[raw.pageid].links, 'title');
		});
		if (aggregated) {
			return (0, _util.aggregatePagination)(_pagination);
		}
		return _pagination;
	}

	/**
  * Paginated categories from page
  * @example
  * wiki.page('batman').then(page => page.categories()).then(console.log);
  * @method WikiPage#categories
  * @param  {Boolean} [aggregated] - return all categories (default is true)
  * @param  {Number} [limit] - number of categories per page
  * @return {Promise} - returns results if aggregated [and next function for more results if not aggregated]
  */
	function categories() {
		var aggregated = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
		var limit = arguments.length <= 1 || arguments[1] === undefined ? 100 : arguments[1];

		var _pagination = (0, _util.pagination)(apiOptions, {
			prop: 'categories',
			pllimit: limit,
			titles: raw.title
		}, function (res) {
			return _underscore2.default.pluck(res.query.pages[raw.pageid].categories, 'title');
		});
		if (aggregated) {
			return (0, _util.aggregatePagination)(_pagination);
		}
		return _pagination;
	}

	/**
  * Geographical coordinates from page
  * @example
  * wiki().page('Texas').then(texas => texas.coordinates())
  * @method WikiPage#coordinates
  * @return {Promise}
  */
	function coordinates() {
		return (0, _util.api)(apiOptions, {
			prop: 'coordinates',
			titles: raw.title
		}).then(function (res) {
			var page = res.query.pages[raw.pageid];
			if (page.coordinates) {
				return page.coordinates[0];
			}
			// No coordinates for this page, check infobox for deprecated version
			return info().then(function (data) {
				if (data.latd && data.longd) {
					return Object.assign({
						type: 'deprecated'
					}, parseDeprecatedCoord(data.latd), parseDeprecatedCoord(data.longd));
				}
				// No coordinates
				return null;
			});
		});
	}

	/**
  * Get information from page
  * @example
  * new Wiki().page('Batman').then(page => page.info('alter_ego'));
  * @method WikiPage#info
  * @param  {String} [key] - Information key
  * @return {Promise} - info Object contains key/value pairs of infobox data, or specific value if key given
  */
	function info(key) {
		return (0, _util.api)(apiOptions, {
			prop: 'revisions',
			rvprop: 'content',
			rvsection: 0,
			titles: raw.title
		}).then(function (res) {
			return markupParser(JSON.stringify(res));
		}).then(function (metadata) {
			if (!key) {
				return metadata;
			}
			if (metadata.hasOwnProperty(key)) {
				return metadata[key];
			}
			if (_determiners2.default.hasOwnProperty(key)) {
				var value = _determiners2.default[key](metadata);
				if (value) {
					return value;
				}
			}
			return undefined;
		});
	}

	/**
  * Paginated backlinks from page
  * @method WikiPage#backlinks
  * @param  {Boolean} [aggregated] - return all backlinks (default is true)
  * @param  {Number} [limit] - number of backlinks per page
  * @return {Promise} - includes results [and next function for more results if not aggregated]
  */
	function backlinks() {
		var aggregated = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
		var limit = arguments.length <= 1 || arguments[1] === undefined ? 100 : arguments[1];

		var _pagination = (0, _util.pagination)(apiOptions, {
			list: 'backlinks',
			bllimit: limit,
			bltitle: raw.title
		}, function (res) {
			return _underscore2.default.pluck(res.query.backlinks, 'title');
		});
		if (aggregated) {
			return (0, _util.aggregatePagination)(_pagination);
		}
		return _pagination;
	}

	var page = {
		raw: raw,
		html: html,
		content: content,
		summary: summary,
		images: images,
		references: references,
		links: links,
		categories: categories,
		coordinates: coordinates,
		info: info,
		backlinks: backlinks,
		rawImages: rawImages,
		mainImage: mainImage
	};

	return page;
}
//# sourceMappingURL=data:application/json;base64,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O0FBSDZCLEdBQXZCLEVBSWpCO0FBQUEsVUFBTyxxQkFBRSxLQUFGLENBQVEsSUFBSSxLQUFKLENBQVUsU0FBbEIsRUFBNkIsT0FBN0IsQ0FBUDtBQUFBLEdBSmlCLENBQXBCO0FBS0EsTUFBSSxVQUFKLEVBQWdCO0FBQ2YsVUFBTywrQkFBb0IsV0FBcEIsQ0FBUDtBQUNBO0FBQ0QsU0FBTyxXQUFQO0FBQ0E7O0FBRUQsS0FBTSxPQUFPO0FBQ1osVUFEWTtBQUVaLFlBRlk7QUFHWixrQkFIWTtBQUlaLGtCQUpZO0FBS1osZ0JBTFk7QUFNWix3QkFOWTtBQU9aLGNBUFk7QUFRWix3QkFSWTtBQVNaLDBCQVRZO0FBVVosWUFWWTtBQVdaLHNCQVhZO0FBWVosc0JBWlk7QUFhWjtBQWJZLEVBQWI7O0FBZ0JDLFFBQU8sSUFBUDtBQUNEIiwiZmlsZSI6InBhZ2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICd1bmRlcnNjb3JlJztcbmltcG9ydCB7IGFnZ3JlZ2F0ZVBhZ2luYXRpb24sIHBhZ2luYXRpb24sIGFwaSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgZGV0ZXJtaW5lcnMgZnJvbSAnLi9kZXRlcm1pbmVycyc7XG5pbXBvcnQgd2lraUluZm9ib3hQYXJzZXIgZnJvbSAnd2lraS1pbmZvYm94LXBhcnNlci1jb3JlJztcblxuZnVuY3Rpb24gbWFya3VwUGFyc2VyKGRhdGEpIHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHR3aWtpSW5mb2JveFBhcnNlcihkYXRhLCAoZXJyLCByZXN1bHRTdHJpbmcpID0+IHtcblx0XHRcdGlmIChlcnIpIHtcblx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRyZXNvbHZlKEpTT04ucGFyc2UocmVzdWx0U3RyaW5nKSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0pO1xufVxuXG5jb25zdCBrZXlWYWx1ZVBhaXJQYXR0ZXJuID0gL1xcdys9W1xcZFxcd10rL2c7XG5cbmZ1bmN0aW9uIHBhcnNlRGVwcmVjYXRlZENvb3JkKGNvb3JkKSB7XG4gIHJldHVybiBjb29yZFxuICAgIC5tYXRjaChrZXlWYWx1ZVBhaXJQYXR0ZXJuKVxuICAgIC5yZWR1Y2UoKG1lbW8sIHBhaXIpID0+IHtcbiAgICAgIGNvbnN0IFtrZXksIHZhbHVlXSA9IHBhaXIuc3BsaXQoJz0nKTtcbiAgICAgIGNvbnN0IGZsb2F0VmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBtZW1vLCB7XG4gICAgICAgIFtrZXldOiBpc05hTihmbG9hdFZhbHVlKSA/IHZhbHVlIDogZmxvYXRWYWx1ZVxuICAgICAgfSlcbiAgICB9LCB7fSk7XG59XG5cbi8qKlxuICogV2lraVBhZ2VcbiAqIEBuYW1lc3BhY2UgV2lraVBhZ2VcbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gd2lraVBhZ2UocmF3UGFnZUluZm8sIGFwaU9wdGlvbnMpIHtcblxuXHRjb25zdCByYXcgPSByYXdQYWdlSW5mbztcblxuXHQvKipcblx0ICogSFRNTCBmcm9tIHBhZ2Vcblx0ICogQGV4YW1wbGVcblx0ICogd2lraS5wYWdlKCdiYXRtYW4nKS50aGVuKHBhZ2UgPT4gcGFnZS5odG1sKCkpLnRoZW4oY29uc29sZS5sb2cpO1xuXHQgKiBAbWV0aG9kIFdpa2lQYWdlI2h0bWxcblx0ICogQHJldHVybiB7UHJvbWlzZX1cblx0ICovXG5cdGZ1bmN0aW9uIGh0bWwoKSB7XG5cdFx0cmV0dXJuIGFwaShhcGlPcHRpb25zLCB7XG5cdFx0XHRcdHByb3A6ICdyZXZpc2lvbnMnLFxuXHRcdFx0XHRydnByb3A6ICdjb250ZW50Jyxcblx0XHRcdFx0cnZsaW1pdDogMSxcblx0XHRcdFx0cnZwYXJzZTogJycsXG5cdFx0XHRcdHRpdGxlczogcmF3LnRpdGxlXG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4ocmVzID0+IHJlcy5xdWVyeS5wYWdlc1tyYXcucGFnZWlkXS5yZXZpc2lvbnNbMF1bJyonXSk7XG5cdH1cblxuXHQvKipcblx0ICogVGV4dCBjb250ZW50IGZyb20gcGFnZVxuXHQgKiBAZXhhbXBsZVxuXHQgKiB3aWtpLnBhZ2UoJ2JhdG1hbicpLnRoZW4ocGFnZSA9PiBwYWdlLmNvbnRlbnQoKSkudGhlbihjb25zb2xlLmxvZyk7XG5cdCAqIEBtZXRob2QgV2lraVBhZ2UjY29udGVudFxuXHQgKiBAcmV0dXJuIHtQcm9taXNlfVxuXHQgKi9cblx0ZnVuY3Rpb24gY29udGVudCgpIHtcblx0XHRyZXR1cm4gYXBpKGFwaU9wdGlvbnMsIHtcblx0XHRcdFx0cHJvcDogJ2V4dHJhY3RzJyxcblx0XHRcdFx0ZXhwbGFpbnRleHQ6ICcnLFxuXHRcdFx0XHR0aXRsZXM6IHJhdy50aXRsZVxuXHRcdFx0fSlcblx0XHRcdC50aGVuKHJlcyA9PiByZXMucXVlcnkucGFnZXNbcmF3LnBhZ2VpZF0uZXh0cmFjdCk7XG5cdH1cblxuXHQvKipcblx0ICogVGV4dCBzdW1tYXJ5IGZyb20gcGFnZVxuXHQgKiBAZXhhbXBsZVxuXHQgKiB3aWtpLnBhZ2UoJ2JhdG1hbicpLnRoZW4ocGFnZSA9PiBwYWdlLnN1bW1hcnkoKSkudGhlbihjb25zb2xlLmxvZyk7XG5cdCAqIEBtZXRob2QgV2lraVBhZ2Ujc3VtbWFyeVxuXHQgKiBAcmV0dXJuIHtQcm9taXNlfVxuXHQgKi9cblx0ZnVuY3Rpb24gc3VtbWFyeSgpIHtcblx0XHRyZXR1cm4gYXBpKGFwaU9wdGlvbnMsIHtcblx0XHRcdFx0cHJvcDogJ2V4dHJhY3RzJyxcblx0XHRcdFx0ZXhwbGFpbnRleHQ6ICcnLFxuXHRcdFx0XHRleGludHJvOiAnJyxcblx0XHRcdFx0dGl0bGVzOiByYXcudGl0bGVcblx0XHRcdH0pXG5cdFx0XHQudGhlbihyZXMgPT4gcmVzLnF1ZXJ5LnBhZ2VzW3Jhdy5wYWdlaWRdLmV4dHJhY3QpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJhdyBkYXRhIGZyb20gaW1hZ2VzIGZyb20gcGFnZVxuXHQgKiBAZXhhbXBsZVxuXHQgKiB3aWtpLnBhZ2UoJ2JhdG1hbicpLnRoZW4ocGFnZSA9PiBwYWdlLnJhd0ltYWdlcygpKS50aGVuKGNvbnNvbGUubG9nKTtcblx0ICogQG1ldGhvZCBXaWtpUGFnZSNyYXdJbWFnZXNcblx0ICogQHJldHVybiB7UHJvbWlzZX1cblx0ICovXG5cdGZ1bmN0aW9uIHJhd0ltYWdlcygpIHtcblx0XHRyZXR1cm4gYXBpKGFwaU9wdGlvbnMsIHtcblx0XHRcdFx0Z2VuZXJhdG9yOiAnaW1hZ2VzJyxcblx0XHRcdFx0Z2ltbGltaXQ6ICdtYXgnLFxuXHRcdFx0XHRwcm9wOiAnaW1hZ2VpbmZvJyxcblx0XHRcdFx0aWlwcm9wOiAndXJsJyxcblx0XHRcdFx0dGl0bGVzOiByYXcudGl0bGVcblx0XHRcdH0pXG5cdFx0XHQudGhlbihyZXMgPT4ge1xuXHRcdFx0XHRpZiAocmVzLnF1ZXJ5KSB7XG5cdFx0XHRcdFx0cmV0dXJuIF8udmFsdWVzKHJlcy5xdWVyeS5wYWdlcyk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIFtdO1xuXHRcdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogTWFpbiBpbWFnZSBVUkwgZnJvbSBpbmZvYm94IG9uIHBhZ2Vcblx0ICogQGV4YW1wbGVcblx0ICogd2lraS5wYWdlKCdiYXRtYW4nKS50aGVuKHBhZ2UgPT4gcGFnZS5tYWluSW1hZ2UoKSkudGhlbihjb25zb2xlLmxvZyk7XG5cdCAqIEBtZXRob2QgV2lraVBhZ2UjbWFpbkltYWdlXG5cdCAqIEByZXR1cm4ge1Byb21pc2V9XG5cdCAqL1xuXHRmdW5jdGlvbiBtYWluSW1hZ2UoKSB7XG5cdFx0cmV0dXJuIFByb21pc2UuYWxsKFtyYXdJbWFnZXMoKSwgaW5mbygpXSlcblx0XHRcdC50aGVuKChbaW1hZ2VzLCBpbmZvXSkgPT4ge1xuXHRcdFx0XHRjb25zdCBpbWFnZSA9IGltYWdlcy5maW5kKGltYWdlID0+IGltYWdlLnRpdGxlID09PSBgRmlsZToke2luZm8uaW1hZ2V9YCk7XG5cdFx0XHRcdHJldHVybiBpbWFnZS5pbWFnZWluZm8ubGVuZ3RoID4gMCA/IGltYWdlLmltYWdlaW5mb1swXS51cmwgOiB1bmRlZmluZWQ7XG5cdFx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbWFnZSBVUkwncyBmcm9tIHBhZ2Vcblx0ICogQGV4YW1wbGVcblx0ICogd2lraS5wYWdlKCdiYXRtYW4nKS50aGVuKHBhZ2UgPT4gcGFnZS5pbWFnZSgpKS50aGVuKGNvbnNvbGUubG9nKTtcblx0ICogQG1ldGhvZCBXaWtpUGFnZSNpbWFnZXNcblx0ICogQHJldHVybiB7UHJvbWlzZX1cblx0ICovXG5cdGZ1bmN0aW9uIGltYWdlcygpIHtcblx0XHRyZXR1cm4gcmF3SW1hZ2VzKClcblx0XHRcdC50aGVuKGltYWdlcyA9PiB7XG5cdFx0XHRcdHJldHVybiBfLmNoYWluKGltYWdlcylcblx0XHRcdFx0XHQucGx1Y2soJ2ltYWdlaW5mbycpXG5cdFx0XHRcdFx0LmZsYXR0ZW4oKVxuXHRcdFx0XHRcdC5wbHVjaygndXJsJylcblx0XHRcdFx0XHQudmFsdWUoKTtcblx0XHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlZmVyZW5jZXMgZnJvbSBwYWdlXG5cdCAqIEBleGFtcGxlXG5cdCAqIHdpa2kucGFnZSgnYmF0bWFuJykudGhlbihwYWdlID0+IHBhZ2UucmVmZXJlbmNlcygpKS50aGVuKGNvbnNvbGUubG9nKTtcblx0ICogQG1ldGhvZCBXaWtpUGFnZSNyZWZlcmVuY2VzXG5cdCAqIEByZXR1cm4ge1Byb21pc2V9XG5cdCAqL1xuXHRmdW5jdGlvbiByZWZlcmVuY2VzKCkge1xuXHRcdHJldHVybiBhcGkoYXBpT3B0aW9ucywge1xuXHRcdFx0XHRwcm9wOiAnZXh0bGlua3MnLFxuXHRcdFx0XHRlbGxpbWl0OiAnbWF4Jyxcblx0XHRcdFx0dGl0bGVzOiByYXcudGl0bGVcblx0XHRcdH0pXG5cdFx0XHQudGhlbihyZXMgPT4gXy5wbHVjayhyZXMucXVlcnkucGFnZXNbcmF3LnBhZ2VpZF0uZXh0bGlua3MsICcqJykpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFBhZ2luYXRlZCBsaW5rcyBmcm9tIHBhZ2Vcblx0ICogQGV4YW1wbGVcblx0ICogd2lraS5wYWdlKCdiYXRtYW4nKS50aGVuKHBhZ2UgPT4gcGFnZS5saW5rcygpKS50aGVuKGNvbnNvbGUubG9nKTtcblx0ICogQG1ldGhvZCBXaWtpUGFnZSNsaW5rc1xuXHQgKiBAcGFyYW0gIHtCb29sZWFufSBbYWdncmVnYXRlZF0gLSByZXR1cm4gYWxsIGxpbmtzIChkZWZhdWx0IGlzIHRydWUpXG5cdCAqIEBwYXJhbSAge051bWJlcn0gW2xpbWl0XSAtIG51bWJlciBvZiBsaW5rcyBwZXIgcGFnZVxuXHQgKiBAcmV0dXJuIHtQcm9taXNlfSAtIHJldHVybnMgcmVzdWx0cyBpZiBhZ2dyZWdhdGVkIFthbmQgbmV4dCBmdW5jdGlvbiBmb3IgbW9yZSByZXN1bHRzIGlmIG5vdCBhZ2dyZWdhdGVkXVxuXHQgKi9cblx0ZnVuY3Rpb24gbGlua3MoYWdncmVnYXRlZCA9IHRydWUsIGxpbWl0ID0gMTAwKSB7XG5cdFx0Y29uc3QgX3BhZ2luYXRpb24gPSBwYWdpbmF0aW9uKGFwaU9wdGlvbnMsIHtcblx0XHRcdHByb3A6ICdsaW5rcycsXG5cdFx0XHRwbG5hbWVzcGFjZTogMCxcblx0XHRcdHBsbGltaXQ6IGxpbWl0LFxuXHRcdFx0dGl0bGVzOiByYXcudGl0bGVcblx0XHR9LCByZXMgPT4gXy5wbHVjayhyZXMucXVlcnkucGFnZXNbcmF3LnBhZ2VpZF0ubGlua3MsICd0aXRsZScpKTtcblx0XHRpZiAoYWdncmVnYXRlZCkge1xuXHRcdFx0cmV0dXJuIGFnZ3JlZ2F0ZVBhZ2luYXRpb24oX3BhZ2luYXRpb24pO1xuXHRcdH1cblx0XHRyZXR1cm4gX3BhZ2luYXRpb247XG5cdH1cblxuXHQvKipcblx0ICogUGFnaW5hdGVkIGNhdGVnb3JpZXMgZnJvbSBwYWdlXG5cdCAqIEBleGFtcGxlXG5cdCAqIHdpa2kucGFnZSgnYmF0bWFuJykudGhlbihwYWdlID0+IHBhZ2UuY2F0ZWdvcmllcygpKS50aGVuKGNvbnNvbGUubG9nKTtcblx0ICogQG1ldGhvZCBXaWtpUGFnZSNjYXRlZ29yaWVzXG5cdCAqIEBwYXJhbSAge0Jvb2xlYW59IFthZ2dyZWdhdGVkXSAtIHJldHVybiBhbGwgY2F0ZWdvcmllcyAoZGVmYXVsdCBpcyB0cnVlKVxuXHQgKiBAcGFyYW0gIHtOdW1iZXJ9IFtsaW1pdF0gLSBudW1iZXIgb2YgY2F0ZWdvcmllcyBwZXIgcGFnZVxuXHQgKiBAcmV0dXJuIHtQcm9taXNlfSAtIHJldHVybnMgcmVzdWx0cyBpZiBhZ2dyZWdhdGVkIFthbmQgbmV4dCBmdW5jdGlvbiBmb3IgbW9yZSByZXN1bHRzIGlmIG5vdCBhZ2dyZWdhdGVkXVxuXHQgKi9cblx0ZnVuY3Rpb24gY2F0ZWdvcmllcyhhZ2dyZWdhdGVkID0gdHJ1ZSwgbGltaXQgPSAxMDApIHtcblx0XHRjb25zdCBfcGFnaW5hdGlvbiA9IHBhZ2luYXRpb24oYXBpT3B0aW9ucywge1xuXHRcdFx0cHJvcDogJ2NhdGVnb3JpZXMnLFxuXHRcdFx0cGxsaW1pdDogbGltaXQsXG5cdFx0XHR0aXRsZXM6IHJhdy50aXRsZVxuXHRcdH0sIHJlcyA9PiBfLnBsdWNrKHJlcy5xdWVyeS5wYWdlc1tyYXcucGFnZWlkXS5jYXRlZ29yaWVzLCAndGl0bGUnKSk7XG5cdFx0aWYgKGFnZ3JlZ2F0ZWQpIHtcblx0XHRcdHJldHVybiBhZ2dyZWdhdGVQYWdpbmF0aW9uKF9wYWdpbmF0aW9uKTtcblx0XHR9XG5cdFx0cmV0dXJuIF9wYWdpbmF0aW9uO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdlb2dyYXBoaWNhbCBjb29yZGluYXRlcyBmcm9tIHBhZ2Vcblx0ICogQGV4YW1wbGVcblx0ICogd2lraSgpLnBhZ2UoJ1RleGFzJykudGhlbih0ZXhhcyA9PiB0ZXhhcy5jb29yZGluYXRlcygpKVxuXHQgKiBAbWV0aG9kIFdpa2lQYWdlI2Nvb3JkaW5hdGVzXG5cdCAqIEByZXR1cm4ge1Byb21pc2V9XG5cdCAqL1xuXHRmdW5jdGlvbiBjb29yZGluYXRlcygpIHtcblx0XHRyZXR1cm4gYXBpKGFwaU9wdGlvbnMsIHtcblx0XHRcdFx0cHJvcDogJ2Nvb3JkaW5hdGVzJyxcblx0XHRcdFx0dGl0bGVzOiByYXcudGl0bGVcblx0XHRcdH0pXG5cdFx0XHQudGhlbihyZXMgPT4ge1xuXHRcdFx0XHRjb25zdCBwYWdlID0gcmVzLnF1ZXJ5LnBhZ2VzW3Jhdy5wYWdlaWRdO1xuXHRcdFx0XHRpZiAocGFnZS5jb29yZGluYXRlcykge1xuXHRcdFx0XHRcdHJldHVybiBwYWdlLmNvb3JkaW5hdGVzWzBdO1xuXHRcdFx0XHR9XG5cdFx0XHRcdC8vIE5vIGNvb3JkaW5hdGVzIGZvciB0aGlzIHBhZ2UsIGNoZWNrIGluZm9ib3ggZm9yIGRlcHJlY2F0ZWQgdmVyc2lvblxuICAgICAgICByZXR1cm4gaW5mbygpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgaWYgKGRhdGEubGF0ZCAmJiBkYXRhLmxvbmdkKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdkZXByZWNhdGVkJ1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBwYXJzZURlcHJlY2F0ZWRDb29yZChkYXRhLmxhdGQpLFxuICAgICAgICAgICAgICBwYXJzZURlcHJlY2F0ZWRDb29yZChkYXRhLmxvbmdkKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gTm8gY29vcmRpbmF0ZXNcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSk7XG5cdFx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgaW5mb3JtYXRpb24gZnJvbSBwYWdlXG5cdCAqIEBleGFtcGxlXG5cdCAqIG5ldyBXaWtpKCkucGFnZSgnQmF0bWFuJykudGhlbihwYWdlID0+IHBhZ2UuaW5mbygnYWx0ZXJfZWdvJykpO1xuXHQgKiBAbWV0aG9kIFdpa2lQYWdlI2luZm9cblx0ICogQHBhcmFtICB7U3RyaW5nfSBba2V5XSAtIEluZm9ybWF0aW9uIGtleVxuXHQgKiBAcmV0dXJuIHtQcm9taXNlfSAtIGluZm8gT2JqZWN0IGNvbnRhaW5zIGtleS92YWx1ZSBwYWlycyBvZiBpbmZvYm94IGRhdGEsIG9yIHNwZWNpZmljIHZhbHVlIGlmIGtleSBnaXZlblxuXHQgKi9cblx0ZnVuY3Rpb24gaW5mbyhrZXkpIHtcblx0XHRyZXR1cm4gYXBpKGFwaU9wdGlvbnMsIHtcblx0XHRcdFx0cHJvcDogJ3JldmlzaW9ucycsXG5cdFx0XHRcdHJ2cHJvcDogJ2NvbnRlbnQnLFxuXHRcdFx0XHRydnNlY3Rpb246IDAsXG5cdFx0XHRcdHRpdGxlczogcmF3LnRpdGxlXG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4ocmVzID0+IG1hcmt1cFBhcnNlcihKU09OLnN0cmluZ2lmeShyZXMpKSlcblx0XHRcdC50aGVuKG1ldGFkYXRhID0+IHtcblx0XHRcdFx0aWYgKCFrZXkpIHtcblx0XHRcdFx0XHRyZXR1cm4gbWV0YWRhdGE7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKG1ldGFkYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcblx0XHRcdFx0XHRyZXR1cm4gbWV0YWRhdGFba2V5XTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoZGV0ZXJtaW5lcnMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuXHRcdFx0XHRcdGNvbnN0IHZhbHVlID0gZGV0ZXJtaW5lcnNba2V5XShtZXRhZGF0YSk7XG5cdFx0XHRcdFx0aWYgKHZhbHVlKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gdmFsdWU7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdFx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBQYWdpbmF0ZWQgYmFja2xpbmtzIGZyb20gcGFnZVxuXHQgKiBAbWV0aG9kIFdpa2lQYWdlI2JhY2tsaW5rc1xuXHQgKiBAcGFyYW0gIHtCb29sZWFufSBbYWdncmVnYXRlZF0gLSByZXR1cm4gYWxsIGJhY2tsaW5rcyAoZGVmYXVsdCBpcyB0cnVlKVxuXHQgKiBAcGFyYW0gIHtOdW1iZXJ9IFtsaW1pdF0gLSBudW1iZXIgb2YgYmFja2xpbmtzIHBlciBwYWdlXG5cdCAqIEByZXR1cm4ge1Byb21pc2V9IC0gaW5jbHVkZXMgcmVzdWx0cyBbYW5kIG5leHQgZnVuY3Rpb24gZm9yIG1vcmUgcmVzdWx0cyBpZiBub3QgYWdncmVnYXRlZF1cblx0ICovXG5cdGZ1bmN0aW9uIGJhY2tsaW5rcyhhZ2dyZWdhdGVkID0gdHJ1ZSwgbGltaXQgPSAxMDApIHtcblx0XHRjb25zdCBfcGFnaW5hdGlvbiA9IHBhZ2luYXRpb24oYXBpT3B0aW9ucywge1xuXHRcdFx0bGlzdDogJ2JhY2tsaW5rcycsXG5cdFx0XHRibGxpbWl0OiBsaW1pdCxcblx0XHRcdGJsdGl0bGU6IHJhdy50aXRsZVxuXHRcdH0sIHJlcyA9PiBfLnBsdWNrKHJlcy5xdWVyeS5iYWNrbGlua3MsICd0aXRsZScpKTtcblx0XHRpZiAoYWdncmVnYXRlZCkge1xuXHRcdFx0cmV0dXJuIGFnZ3JlZ2F0ZVBhZ2luYXRpb24oX3BhZ2luYXRpb24pO1xuXHRcdH1cblx0XHRyZXR1cm4gX3BhZ2luYXRpb247XG5cdH1cblxuXHRjb25zdCBwYWdlID0ge1xuXHRcdHJhdyxcblx0XHRodG1sLFxuXHRcdGNvbnRlbnQsXG5cdFx0c3VtbWFyeSxcblx0XHRpbWFnZXMsXG5cdFx0cmVmZXJlbmNlcyxcblx0XHRsaW5rcyxcblx0XHRjYXRlZ29yaWVzLFxuXHRcdGNvb3JkaW5hdGVzLFxuXHRcdGluZm8sXG5cdFx0YmFja2xpbmtzLFxuXHRcdHJhd0ltYWdlcyxcblx0XHRtYWluSW1hZ2Vcblx0fTtcblxuICByZXR1cm4gcGFnZTtcbn1cbiJdfQ==